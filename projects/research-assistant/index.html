<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Merger arbitrage &amp; Valuation | Frederik K. Ciupek </title> <meta name="author" content="Frederik K. Ciupek"> <meta name="description" content="Insights, tools, and findings from my research assistantship with Prof. Theis Jensen (Yale School of Management), focused on valuation techniques in M&amp;A—ranging from peer group construction to large-scale data extraction from SEC filings. The project combines empirical finance, machine learning, and scalable Python infrastructure to improve how firms are valued in practice. "> <meta name="keywords" content="quantitative investing, portfolio management, alternative data, M&amp;A arbitrage"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://frederikciupek.github.io/projects/research-assistant/"> <script src="/assets/js/theme.js?a81d82887dd692e91686b43de4542f18"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Frederik</span> K. Ciupek </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item active"> <a class="nav-link" href="/projects/">projects <span class="sr-only">(current)</span> </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">submenus </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item " href="/books/">bookshelf</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/blog/">blog</a> </div> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Merger arbitrage &amp; Valuation</h1> <p class="post-description">Insights, tools, and findings from my research assistantship with Prof. Theis Jensen (Yale School of Management), focused on valuation techniques in M&amp;A—ranging from peer group construction to large-scale data extraction from SEC filings. The project combines empirical finance, machine learning, and scalable Python infrastructure to improve how firms are valued in practice. </p> </header> <article> <p> Over the past few months, I’ve had the incredible opportunity to work as a research assistant under <strong>Professor Theis Jensen</strong> at the Yale School of Management. This experience has fundamentally shaped how I think about financial research-not just as a technical challenge, but as a creative process that bridges academic theory and real-world application. I have always been interested in two aspects of financial research: </p> <ol> <li>The idea generation for some of these most creative ideas that lead to ground-breaking work changing academia as well as industry</li> <li>The pipeline that puts this idea generation process into practice.</li> </ol> <p> Professor Jensen, an Assistant Professor of Finance and a brilliant researcher in empirical asset pricing, focuses on using novel datasets and advanced statistical methods to rethink how we value companies. From day one, he encouraged us not just to help with operational research work but to understand <em>why</em> the work matters - and how it fits into the broader questions driving modern finance. </p> <p> With that I want to focus on the <em> what </em> we have been researching before going into the why and how. </p> <h3>Tackling an Industry Blind Spot: Valuation Techniques</h3> <p> One of the most fascinating parts of our work revolved around a simple yet often overlooked question: <strong>How exactly do companies get valued?</strong> While that might seem straightforward-plug numbers into a DCF or use peer multiples-the reality is that many firms rely on inconsistent, manual, and often outdated methods to determine valuations. </p> <p> The ultimate goal of Prof. Theis' research is aimed to scrutinize these traditional approaches and explore whether machine learning models could provide more accurate, scalable alternatives. After all, accurate valuation isn’t just an academic exercise-it’s central to M&amp;A deals, investment decisions, and strategic planning, with trillions of dollars on the line globally. But that end goal is still a bit off and I was helping with the data gathering, processing and preliminary evaluation of potential techniques. </p> <h3>What I Actually Worked On</h3> <h4><strong>1. Replicating Peer Group Valuation Research</strong></h4> <p> I began by replicating results from the paper <em>"Stick to the Fundamentals and Discover Your Peers"</em> (Knudsen, Kold &amp; Plenborg, 2022 , which proposes that using multivariate financial fundamentals-rather than broad industry labels-leads to more accurate peer groups since industry classification is crude at best. Using a 'sum of absolute rank differences' (SARD) by selecting comparable companies on the basis of the least sum rank across a range of 5 fundamental variables (ROE, Net Debt/EBIT, Size, Implied Growth, EBIT margin) and evaluating companies on 4 multiples (EV/EBIT, EV/Sales, P/B and P/E). The original paper finds that better peer group selection reduces valuation error by up to 20%. The largest difference is seen in the EV/Sale where the absolute valuation error with the SARD method is 0.254 vs 0.406 with the industry peer group. </p> <p> Below is the overall result I was replicating from the paper: </p> <div class="row justify-content-sm-center"> <div class="col-sm-8 mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/theis_research/discover_your_peers_result-480.webp 480w,/assets/img/theis_research/discover_your_peers_result-800.webp 800w,/assets/img/theis_research/discover_your_peers_result-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/theis_research/discover_your_peers_result.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Result table from Knudsen et al. (2022)" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p> Overall we find similar results. I will edit this section with the method/code I used to do so at a later time. </p> <p> </p> <h4><strong>2. Building a Custom M&amp;A Valuation Multiple Dataset</strong></h4> <p> To go further, we needed real-world data. This led me to a massive technical challenge: extracting historical valuation data from over 10,000 M&amp;A filings (DEFM14A and PREM14A) published by the SEC. DEFM14A" stands for Definitive Proxy Statement relating to Mergers under Schedule 14A and is the final version of the proxy statement sent to shareholders to seek approval for a merger, acquisition, or similar transactions. PREM14A stands for Preliminary Proxy Statement relating to Mergers under Schedule 14A and is just the draft version of the DEFM14A. </p> <p> These documents contain crucial information about how firms were valued by investment banks-but each one is unstructured, inconsistently formatted, and buried deep in legalese. </p> <p> </p> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/theis_research/defm14a_preview-480.webp 480w,/assets/img/theis_research/defm14a_preview-800.webp 800w,/assets/img/theis_research/defm14a_preview-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/theis_research/defm14a_preview.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Example DEFM14A cover page" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> This is a cover page from a DEFM14A form requesting shareholders to vote on the merger between Insud Pharma, S.L., a Spanish company (“Insud”), and Exeltis Project, Inc. (a Delaware corporation) </div> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/theis_research/defm14a_selecred_companies_analysis-480.webp 480w,/assets/img/theis_research/defm14a_selecred_companies_analysis-800.webp 800w,/assets/img/theis_research/defm14a_selecred_companies_analysis-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/theis_research/defm14a_selecred_companies_analysis.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Example DEFM14A Opinion of the Financial Advisor Section " loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> This is an snippet from a DEFM14A on the financial analysis regarding the merger between Insud Pharma and Exeltis Project. It shows the selected peer group for the transaction and the implied multiples. </div> <p> </p> <h4> <strong>2.1 Approach to Extracting Valuation Multiples </strong> </h4> <p> Now we are going to become a bit more technical. Extracting valuation multiples from thousands of SEC filings presented two main challenges: (1) locating the relevant “Comparable Companies Analysis” or “Selected Comparable Companies” tables buried in lengthy, unstructured HTML proxy documents (DEFM14A/PREM14A), and (2) reliably parsing those tables - even when each filing used different formatting, column headers, or table layouts. </p> <p> I will walk through the main iterations and not just present the final result. My first idea was to use CrewAI to create a Crew of LLMs that see whether the extraction was successful or not by creating a Reader and Writer Agent with the tasks to read and write. We would go through the whole document looking for certain keywords and create a expanding window around those keywords until a certain string length had been reached. T </p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
</pre></td> <td class="code"><pre><span class="k">def</span> <span class="nf">preprocess_html</span><span class="p">(</span><span class="n">extracted_content</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Cleans and prepares the extracted content.</span><span class="sh">"""</span>
    <span class="n">soup</span> <span class="o">=</span> <span class="nc">BeautifulSoup</span><span class="p">(</span><span class="n">extracted_content</span><span class="p">,</span> <span class="sh">'</span><span class="s">html.parser</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">soup</span><span class="p">.</span><span class="nf">get_text</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
<span class="k">def</span> <span class="nf">extract_passages</span><span class="p">(</span><span class="n">html_content</span><span class="p">,</span> <span class="n">keyword_list</span><span class="p">,</span> <span class="n">lines_before_and_after</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Extracts relevant passages containing the keyword, including lines_before_and_after lines before and after.</span><span class="sh">"""</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">Characters before extracting: </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">html_content</span><span class="p">)</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">html_content</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="se">\n</span><span class="sh">'</span><span class="p">)</span>
    
    <span class="c1"># Normalize keyword for case-insensitive search
</span>    <span class="n">keyword_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">keyword</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">keyword_list</span><span class="p">]</span>
    
    <span class="c1"># Find indices of lines containing the keyword
</span>    <span class="n">keyword_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">keyword</span> <span class="ow">in</span> <span class="n">line</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">keyword_list</span><span class="p">)]</span>
    
    <span class="c1"># Extract lines_before_and_after lines before and after each match
</span>    <span class="n">passages</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">keyword_indices</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">idx</span> <span class="o">-</span> <span class="n">lines_before_and_after</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span> <span class="n">idx</span> <span class="o">+</span> <span class="n">lines_before_and_after</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">passage</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]).</span><span class="nf">strip</span><span class="p">()</span>
        <span class="n">passages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">passage</span><span class="p">)</span>

    <span class="n">extracted_content</span> <span class="o">=</span> <span class="sh">"</span><span class="s">; New passage:</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">passages</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">Characters after extracting: </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">extracted_content</span><span class="p">)</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>

    <span class="n">output</span> <span class="o">=</span> <span class="nf">preprocess_html</span><span class="p">(</span><span class="n">extracted_content</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">Characters of output: </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span>

<span class="k">def</span> <span class="nf">write_dict_to_excel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="sh">"</span><span class="s">output.xlsx</span><span class="sh">"</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">pd</span><span class="p">.</span><span class="nc">ExcelWriter</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="sh">'</span><span class="s">openpyxl</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">({</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">value</span><span class="p">]})</span>
            <span class="k">elif</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="nf">items</span><span class="p">()))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Unsupported data type for key </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="nf">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">df</span><span class="p">.</span><span class="nf">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="n">key</span><span class="p">[:</span><span class="mi">31</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>  <span class="c1"># Sheet names are limited to 31 characters
</span>
<span class="c1">#%% Crew
</span>
<span class="c1"># Agent: Reader
</span><span class="n">reader</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
    <span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">Reader and relevant text passage finder</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">goal</span><span class="o">=</span><span class="sh">"</span><span class="s">Identify and extract text passages related to comparable valuations from an HTML file.</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">backstory</span><span class="o">=</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">You</span><span class="sh">'</span><span class="s">re working on exploring comparable company analyses. Your role is to parse through a preprocessed HTML code </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">and extract all text passages that describe or entail results of a comparable company analysis (e.g. peer groups and multiple valuations). </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">Your work is the input for the writer agent to extract certain comparable valuation data.</span><span class="sh">"</span>
    <span class="p">),</span>
    <span class="n">allow_delegation</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span>
<span class="p">)</span>

<span class="c1"># Agent: Writer
</span><span class="n">writer</span> <span class="o">=</span> <span class="nc">Agent</span><span class="p">(</span>
    <span class="n">role</span><span class="o">=</span><span class="sh">"</span><span class="s">Writer</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">goal</span><span class="o">=</span><span class="sh">"</span><span class="s">Extract DCF information from text passages and save it in an dictionary.</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">backstory</span><span class="o">=</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">You</span><span class="sh">'</span><span class="s">re working on exploring comparable company valuation analyses. You analyze text passages provided by the reader agent. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">These passages contain information related to comparable company valuation analyses which describe how other firms that belong to peer groups in M&amp;A transactions were valued. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">Your role is to process this information and create a dictionary.</span><span class="sh">"</span>
    <span class="p">),</span>
    <span class="n">allow_delegation</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span>
<span class="p">)</span>

<span class="c1"># Task: Read
</span><span class="n">read</span> <span class="o">=</span> <span class="nc">Task</span><span class="p">(</span>
    <span class="n">description</span><span class="o">=</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">1. Parse the HTML code and identify all text passages related to a comparable company valuation analysis.</span><span class="se">\n</span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">2. Retain only the relevant passages and separate them using the delimiter </span><span class="sh">'</span><span class="s">; New passage:</span><span class="sh">'</span><span class="s">.</span><span class="se">\n</span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">3. Ensure that the output text is clean, free of HTML tags (if not already cleaned before), and structured for further processing.</span><span class="se">\n</span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">Please keep in mind it</span><span class="sh">'</span><span class="s">s better to also have unimportant information in the text rather than missing any important information.</span><span class="se">\n</span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">Here is the preprocessed HTML code: {preprocessed_html_content}</span><span class="sh">"</span>
    <span class="p">),</span>
    <span class="n">expected_output</span><span class="o">=</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">A string of text with all relevant comparable company valuation-related passages. Each passage is separated by </span><span class="sh">'</span><span class="s">; New passage:</span><span class="sh">'</span><span class="s"> and </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">each passage should be clean and formatted for easy parsing.</span><span class="sh">"</span>
    <span class="p">),</span>
    <span class="n">agent</span><span class="o">=</span><span class="n">reader</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Task: Write
</span><span class="n">write</span> <span class="o">=</span> <span class="nc">Task</span><span class="p">(</span>
    <span class="n">description</span><span class="o">=</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">1. Read the text passages provided by the Reader agent, separated by </span><span class="sh">'</span><span class="s">; New passage:</span><span class="sh">'</span><span class="s">.</span><span class="se">\n</span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">2. Extract and organize the following details into a structured dictionary. If you cannot find corresponding </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">information, please let the associated fields empty and do not make up data:</span><span class="se">\n</span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">   - `comparables_text`: A string containing the text parts related to a comparable company valuation analysis.</span><span class="se">\n</span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">   - `comparables_valuation`: A list of dictionaries, each containing information:</span><span class="se">\n</span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">       * `date`: The date on which the valuation was performed.</span><span class="se">\n</span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">       * `statistic`: Which statistic was used on the references ranges of the characteristics. Often different reference ranges (1st quartile, median, mean, 3rd quartiel) are used to estimate the valuation multiple. </span><span class="se">\n</span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">       * `numerator`: The numerator of the valuation ratio used for the comparable company valuation analysis.</span><span class="sh">"</span> 
        <span class="sh">"</span><span class="s">If the table or text says </span><span class="sh">'</span><span class="s">enterprise value as a multiple of ... </span><span class="sh">'</span><span class="s"> that means that the numerator is the company characteristic mentioned next.  .</span><span class="se">\n</span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">       * `denominator`: The denominator of the valuation ratio used for the comparable company valuation analysis.</span><span class="sh">"</span> 
        <span class="sh">"</span><span class="s">If a subheadline notes for example </span><span class="sh">'</span><span class="s">enterprise value as a multiple of ... </span><span class="sh">'</span><span class="s">, the denominator is the enterprise value .</span><span class="se">\n</span><span class="sh">"</span>
        <span class="sh">'</span><span class="s">       * `multiple`: The multiple used for the valuation (e.g., </span><span class="sh">"</span><span class="s">6.0x</span><span class="sh">"</span><span class="s"> or some %).</span><span class="se">\n</span><span class="sh">'</span>
        <span class="sh">"</span><span class="s">       * `valuation`: If applicable, the share price that would result from the multiple before (e.g. $2.00).</span><span class="se">\n</span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">   - `comparables_peers`: A list of dictionaries containing information about all the peers used to calcualte the multiples in the comparables_valuation dictionary :</span><span class="se">\n</span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">       * `advisor`: The name of the financial advisor carrying out the analyses</span><span class="sh">'</span><span class="se">\n</span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">       * `peer`: The name of the comparable companies used to calcualte the multiples.</span><span class="se">\n</span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">       * `peer_group`: Which peer group this company belongs to (e.g. semiconductor).</span><span class="se">\n</span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">3. Ensure the output dictionary is complete, consistent, and well-structured. If some information is missing it should be filled </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">with </span><span class="sh">''</span><span class="s"> if a string is expected or with NaN if a number is expected.</span><span class="se">\n</span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">Keep in mind that the reader might also include unimportant information. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">You should only use the information you need to create the dictionary. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">Further, only include important text for the </span><span class="sh">'</span><span class="s">comparables_text</span><span class="sh">'</span><span class="s"> page.</span><span class="sh">"</span>
    <span class="p">),</span>
    <span class="n">expected_output</span><span class="o">=</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">A dictionary with the following keys:</span><span class="se">\n</span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">- `comparables_text`</span><span class="se">\n</span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">- `comparables_valuation`</span><span class="se">\n</span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">- `comparables_peers`</span><span class="se">\n</span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">Each key should contain the relevant extracted information in a structured format, if available. If some information </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">is not available, the corresponding value should be empty.</span><span class="sh">"</span>
    <span class="p">),</span>
    <span class="n">agent</span><span class="o">=</span><span class="n">writer</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Create the crew
</span><span class="n">crew</span> <span class="o">=</span> <span class="nc">Crew</span><span class="p">(</span>
    <span class="n">agents</span><span class="o">=</span><span class="p">[</span><span class="n">reader</span><span class="p">,</span> <span class="n">writer</span><span class="p">],</span>
    <span class="n">tasks</span><span class="o">=</span><span class="p">[</span><span class="n">read</span><span class="p">,</span> <span class="n">write</span><span class="p">],</span>
    <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span>
<span class="p">)</span>

<span class="c1">#%% Read the HTML files
</span><span class="n">path</span> <span class="o">=</span> <span class="n">your</span><span class="o">/</span><span class="n">path</span>
<span class="n">folder</span> <span class="o">=</span> <span class="n">path</span>
<span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="nb">file</span><span class="p">)</span> <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="nb">file</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">file</span><span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">:]</span> <span class="o">!=</span> <span class="sh">'</span><span class="s">DS_Store</span><span class="sh">'</span><span class="p">]</span>
<span class="nf">print</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>

<span class="n">n</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1">### Starting of the expanding window
</span><span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="sh">'</span><span class="s">r</span><span class="sh">'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
        <span class="n">html_content</span> <span class="o">=</span> <span class="nb">file</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
    
    <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">preprocessed_html_content</span> <span class="o">=</span> <span class="sh">''</span>
    <span class="k">while</span> <span class="nf">len</span><span class="p">(</span><span class="n">preprocessed_html_content</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">20000</span><span class="p">:</span>
        <span class="n">j</span> <span class="o">+=</span> <span class="mi">25</span>
        <span class="n">preprocessed_html_content</span> <span class="o">=</span> <span class="nf">extract_passages</span><span class="p">(</span><span class="n">html_content</span><span class="p">,</span> <span class="p">[</span><span class="sh">'</span><span class="s">Financial Analyses</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">comparable public companies</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Transaction Multiples Analysis</span><span class="sh">'</span><span class="p">],</span> <span class="n">j</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">preprocessed_html_content</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">300_000</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">Cannot preprocess file </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>
        <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
    
    <span class="c1"># Run the Crew
</span>    <span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">preprocessed_html_content</span><span class="sh">"</span><span class="p">:</span> <span class="n">preprocessed_html_content</span><span class="p">}</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">crew</span><span class="p">.</span><span class="nf">kickoff</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>

    <span class="c1"># Convert output to dictionary
</span>    <span class="n">data</span> <span class="o">=</span> <span class="n">ast</span><span class="p">.</span><span class="nf">literal_eval</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">raw</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># Write the dictionary to an Excel file
</span>    <span class="n">document_name</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">/</span><span class="sh">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">.</span><span class="sh">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>This was more than suboptimal in many ways:</p> <table> <thead> <tr> <th>Problem 1</th> <th>Problem 2</th> <th>Problem 3</th> <th>Problem 4</th> </tr> </thead> <tbody> <tr> <td> Using the double the tokens for one file making it extremely costly and slow, also limiting us to only using GPT-4o. We want to limit the amounts of tokens we use. </td> <td> The expanding window has one fatal flaw: if we have multiple keywords in adjacent rows and expand around them we would be giving the same information twice. We therefore want to index each keyword found and only expand around it if 1. the size of the whole document is too big to use the entire document (which would always give superior results) and 2. If there are not overlapping windows. That means that only if the expanding index of one keyword does not include the other keyword's index we grow from there. </td> <td> Not differentiating between tables and raw text. As you have seen with the example above, some of the multiple valuations are in the text itself but upon further research the majority of them are in tables. But, just inputting raw HTML tables into LLMs does not work well. Information is lost, columns misunderstood, spaces set where they should not be. </td> <td> Since we also want to know which peer group / peer company the valuation multiple is based on, we want to add an extra column <code>peer_group</code>. But that means that for each table &amp; paragraph that has the valuation information we need context about what peer group we are talking about. Therefore we need to extract extra information, so called <em>context</em> from around especially the table. </td> </tr> </tbody> </table> <p> </p> <h4><strong>2.2 New Iteration: Addressing the Four Key Issues</strong></h4> <p> In the latest version of our pipeline, we overhauled the extraction flow to fix the four problems listed above: </p> <table> <thead> <tr> <th>Problem 1</th> <th>Problem 2</th> <th>Problem 3</th> <th>Problem 4</th> </tr> </thead> <tbody> <tr> <td>Using double tokens per file - too costly/slow, forced GPT-4o only.</td> <td>Overlapping “expanding windows” around adjacent keywords duplicated data.</td> <td>No distinction between tables vs. raw text—tables lost structure when fed directly into the LLM.</td> <td>Missing a <code>peer_group</code> column - need context around each table to know which peer group a multiple belonged to.</td> </tr> </tbody> </table> <p> </p> <p> Below we show how each issue has been addressed in the updated code. Wherever possible, we include the relevant snippets with comments to explain how the fix works. </p> <hr> <h5>Issue 1: Token Explosion → Conditional “full doc” vs. “table + context” calls</h5> <p> <strong>Fix:</strong> Before sending any LLM request, we compute the token count for: </p> <ul> <li>The concatenated tables (as plaintext) <code>table_input</code> </li> <li>The entire HTML (preprocessed) <code>html_string</code> </li> </ul> We only pass the full document as context if <code>token_length + html_string_length ≤ MAX_TOKEN</code>. Otherwise, we switch to “keyword context only.” This ensures we never exceed the 20K‐token limit and drastically reduces cost. <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># Calculate token lengths
</span><span class="n">token_length</span> <span class="o">=</span> <span class="nf">num_tokens_from_string</span><span class="p">(</span><span class="n">table_input</span><span class="p">,</span> <span class="n">encoding</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
<span class="n">html_string_length</span> <span class="o">=</span> <span class="nf">num_tokens_from_string</span><span class="p">(</span><span class="n">html_string</span><span class="p">,</span> <span class="n">encoding</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>

<span class="nf">if </span><span class="p">(</span><span class="n">token_length</span> <span class="o">+</span> <span class="n">html_string</span>\<span class="n">_length</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">MAX_TOKEN</span><span class="p">:</span>
<span class="c1"># Safe to send entire document + tables to the LLM
</span><span class="n">context</span> <span class="o">=</span> <span class="sh">'</span><span class="s">full_doc</span><span class="sh">'</span>
<span class="n">prompt</span><span class="p">,</span> <span class="n">system</span> <span class="o">=</span> <span class="nf">extractor</span><span class="p">(</span><span class="n">table_input</span><span class="p">,</span> <span class="n">html_string</span><span class="p">,</span> <span class="n">batch</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
<span class="c1"># Too many tokens—fall back to “keyword‐only” window
</span><span class="n">context</span> <span class="o">=</span> <span class="sh">'</span><span class="s">keyword_context</span><span class="sh">'</span>
<span class="n">prompt</span><span class="p">,</span> <span class="n">system</span> <span class="o">=</span> <span class="nf">extractor</span><span class="p">(</span><span class="n">table_input</span><span class="p">,</span> <span class="n">keyword_context</span><span class="p">,</span> <span class="n">batch</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># … then format prompt/system into a chat completion request …</span></code></pre></figure> <p> Notice how we never blindly send the whole file. This conditional check ensures we only pay for GPT tokens when necessary, and otherwise rely on the smaller “keyword context” snippet. </p> <hr> <h5>Issue 2: Expanding Windows Overlap → Merge Intervals Instead of Duplicating</h5> <p> Our original code would simply expand <em>±N</em> lines around every keyword index. If two keywords were adjacent, those windows overlapped, producing repeated text. In the new <code>extract_passages</code> we: </p> <ol> <li>Find all line indices containing any keyword.</li> <li>Create an interval <code>(start, end)</code> for each index (where <code>start = index − N/2</code>, <code>end = index + N</code>).</li> <li>Merge any overlapping intervals into one “super‐interval.”</li> <li>Extract each merged interval exactly once, preventing duplication.</li> </ol> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">extract_passages</span><span class="p">(</span><span class="n">html_content</span><span class="p">,</span> <span class="n">keyword_list</span><span class="p">,</span> <span class="n">lines_after</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Extracts passages containing the keyword, including lines_after lines after and int(lines_after/2) before.
       Overlapping passages are merged into a single passage.</span><span class="sh">"""</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">html_content</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="se">\n</span><span class="sh">'</span><span class="p">)</span>
    <span class="c1"># Normalize keywords for case-insensitive search
</span>    <span class="n">keyword_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">keyword</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">keyword_list</span><span class="p">]</span>
    <span class="n">keyword_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">keyword</span> <span class="ow">in</span> <span class="n">line</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">keyword_list</span><span class="p">)]</span>
    
    <span class="c1"># Create intervals for each keyword occurrence
</span>    <span class="n">intervals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">keyword_indices</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">idx</span> <span class="o">-</span> <span class="nf">int</span><span class="p">(</span><span class="n">lines_after</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span> <span class="n">idx</span> <span class="o">+</span> <span class="n">lines_after</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">intervals</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
    
    <span class="c1"># Merge overlapping intervals
</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">intervals</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="n">merged_intervals</span> <span class="o">=</span> <span class="p">[</span><span class="n">intervals</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">for</span> <span class="n">current_start</span><span class="p">,</span> <span class="n">current_end</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">last_start</span><span class="p">,</span> <span class="n">last_end</span> <span class="o">=</span> <span class="n">merged_intervals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">current_start</span> <span class="o">&lt;=</span> <span class="n">last_end</span><span class="p">:</span>  <span class="c1"># Overlapping intervals
</span>            <span class="n">merged_intervals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">last_start</span><span class="p">,</span> <span class="nf">max</span><span class="p">(</span><span class="n">last_end</span><span class="p">,</span> <span class="n">current_end</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">merged_intervals</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">current_start</span><span class="p">,</span> <span class="n">current_end</span><span class="p">))</span>
    
    <span class="c1"># Extract passages from the merged intervals
</span>    <span class="n">passages</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">merged_intervals</span><span class="p">:</span>
        <span class="n">passage</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]).</span><span class="nf">strip</span><span class="p">()</span>
        <span class="n">passages</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">passage</span><span class="p">)</span>
    
    <span class="n">extracted_content</span> <span class="o">=</span> <span class="sh">"</span><span class="s">; New passage:</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">passages</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="nf">preprocess_html</span><span class="p">(</span><span class="n">extracted_content</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span></code></pre></figure> <p> By merging intervals, we guarantee that if keyword A’s window would have covered keyword B’s window, we only extract the overlapped lines one time. </p> <hr> <h5>Issue 3: Tables vs. Raw Text → Separate Table Extraction First</h5> <p> Rather than feed raw HTML into the LLM, we now explicitly parse all <code>&lt;table&gt;</code> elements first, tagging only those that pass a “data table” filter. Once we have a list of valid tables, we extract their surrounding context and concatenate them into <code>table_input</code>. If no valid tables exist, we revert to keyword-driven context extraction. </p> <p><strong>Key functions:</strong></p> <ul> <li> <code>table_contains_keywords(table)</code> checks whether a BeautifulSoup <code>&lt;table&gt;</code> has any multiple‐related keyword.</li> <li> <code>is_data_table(df)</code> confirms that a parsed DataFrame is mostly numeric or explicitly contains “peer” language.</li> <li> <code>extract_table_context(html_string)</code> returns N lines of context before and after the table by indexing each table and taking only context from the valid keyword-data tables.</li> <li> <code>get_valid_tables_with_context(html_string)</code> returns a list of (table‐as‐string, [context_before, context_after]) for each valid table.</li> </ul> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">table_contains_keywords</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Returns True if the table text contains any of the keywords (case-insensitive).</span><span class="sh">"""</span>
    <span class="n">table_text</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="nf">get_text</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>
    <span class="k">return</span> <span class="nf">any</span><span class="p">(</span><span class="n">keyword</span> <span class="ow">in</span> <span class="n">table_text</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">KEYWORDS_TABLES</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">is_data_table</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">numeric_threshold</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">max_text_length</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Determines if a DataFrame is mainly data based on:
      1. Minimum ratio of numeric cells.
      2. No extremely large text blocks.
      3. If keywords like </span><span class="sh">'</span><span class="s">peer</span><span class="sh">'</span><span class="s"> appear.
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="n">df</span><span class="p">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="n">table_text</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">to_string</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span> <span class="c1">##this to_string can stay
</span>    <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">re</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="n">table_text</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="sa">r</span><span class="sh">"</span><span class="s">public(ly)? trading multiples</span><span class="sh">"</span><span class="p">,</span>
        <span class="sa">r</span><span class="sh">"</span><span class="s">peer group</span><span class="sh">"</span><span class="p">,</span>
        <span class="sa">r</span><span class="sh">"</span><span class="s">peer</span><span class="sh">"</span><span class="p">,</span>
        <span class="sa">r</span><span class="sh">"</span><span class="s">multiple range</span><span class="sh">"</span><span class="p">,</span>
        <span class="sa">r</span><span class="sh">"</span><span class="s">selected.*compan(?:y|ies)?</span><span class="sh">"</span><span class="p">,</span>
        <span class="sa">r</span><span class="sh">'</span><span class="s">corporation</span><span class="sh">'</span><span class="p">,</span>
        <span class="sa">r</span><span class="sh">'</span><span class="s">corp</span><span class="sh">'</span>
    <span class="p">]):</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="n">total_cells</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">numeric_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="p">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nf">float</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">val</span><span class="p">).</span><span class="nf">replace</span><span class="p">(</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="p">,</span> <span class="sh">''</span><span class="p">).</span><span class="nf">replace</span><span class="p">(</span><span class="sh">'</span><span class="s">%</span><span class="sh">'</span><span class="p">,</span> <span class="sh">''</span><span class="p">).</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">).</span><span class="nf">replace</span><span class="p">(</span><span class="sh">'</span><span class="s">$</span><span class="sh">'</span><span class="p">,</span><span class="sh">''</span><span class="p">).</span><span class="nf">strip</span><span class="p">())</span>
                <span class="n">numeric_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="n">numeric_ratio</span> <span class="o">=</span> <span class="n">numeric_count</span> <span class="o">/</span> <span class="n">total_cells</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="p">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_text_length</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>

    <span class="k">return</span> <span class="n">numeric_ratio</span> <span class="o">&gt;=</span> <span class="n">numeric_threshold</span>

<span class="k">def</span> <span class="nf">get_valid_tables_with_context</span><span class="p">(</span><span class="n">html_string</span><span class="p">,</span> <span class="n">numeric_threshold</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">context_rows</span><span class="o">=</span><span class="n">TABLE_CONTEXT_CHARS</span><span class="p">):</span>
<span class="sh">"""</span><span class="s">
    Parse all &lt;table&gt; tags with BeautifulSoup. For each:
    1. If `table_contains_keywords` is False, skip entirely.
    2. Otherwise, try `pd.read_html` → one or more DataFrames.
    3. Use `is_data_table` to filter out non‐data DataFrames.
    4. If valid, store both the DataFrame (as text) and its pre/post context.
    Returns:
    - valid_tables_data: list of DataFrame‐strings (e.g. </span><span class="sh">"</span><span class="s">nn</span><span class="sh">"</span><span class="s">.join(df_list))
    - valid_tables_context: list of [context_before, context_after] pairs
    </span><span class="sh">"""</span>

<span class="k">def</span> <span class="nf">get_valid_tables_with_context</span><span class="p">(</span><span class="n">html_string</span><span class="p">,</span> <span class="n">numeric_threshold</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">context_rows</span><span class="o">=</span><span class="n">TABLE_CONTEXT_CHARS</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Parses the HTML to find tables containing keywords. For each table, it attempts to parse
    DataFrames from it and checks if they qualify as data tables. If so, returns the table</span><span class="sh">'</span><span class="s">s
    string data (one or more DataFrames) and its surrounding context.
    
    Returns two lists:
        - valid_tables_data: list of table data strings.
        - valid_tables_context: list of context strings corresponding to each table.
    </span><span class="sh">"""</span>
    <span class="n">soup</span> <span class="o">=</span> <span class="nc">BeautifulSoup</span><span class="p">(</span><span class="n">html_string</span><span class="p">,</span> <span class="sh">"</span><span class="s">html.parser</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">all_tables</span> <span class="o">=</span> <span class="n">soup</span><span class="p">.</span><span class="nf">find_all</span><span class="p">(</span><span class="sh">"</span><span class="s">table</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">valid_tables_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">valid_tables_context</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">all_tables</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">table_contains_keywords</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
            <span class="k">continue</span>
        
        <span class="n">table_html</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dfs</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_html</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nc">StringIO</span><span class="p">(</span><span class="n">table_html</span><span class="p">),</span> <span class="n">flavor</span><span class="o">=</span><span class="sh">"</span><span class="s">bs4</span><span class="sh">"</span><span class="p">)</span>
            <span class="c1"># print(dfs)
</span>        <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
            <span class="k">continue</span>
        
        <span class="n">valid_dfs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">dfs</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="sh">"</span><span class="s">columns</span><span class="sh">"</span><span class="p">).</span><span class="nf">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="sh">"</span><span class="s">rows</span><span class="sh">"</span><span class="p">).</span><span class="nf">fillna</span><span class="p">(</span><span class="sh">""</span><span class="p">)</span>
            <span class="k">if</span> <span class="nf">is_data_table</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">numeric_threshold</span><span class="o">=</span><span class="n">numeric_threshold</span><span class="p">):</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                <span class="n">valid_dfs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="c1"># removed to_strig to allow for better reading of the tables
</span>        <span class="k">if</span> <span class="n">valid_dfs</span><span class="p">:</span>
            <span class="n">valid_tables_data</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">valid_dfs</span><span class="p">)</span>
            <span class="n">context_list</span> <span class="o">=</span> <span class="nf">extract_table_context</span><span class="p">(</span><span class="n">html_string</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">context_rows</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">context_list</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_tables_context</span><span class="p">:</span>
                <span class="n">valid_tables_context</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">context_list</span><span class="p">)</span> 
                  
    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">valid_tables_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># print("Warning: No valid data tables found in the document. Using all keyword tables")
</span>        <span class="n">valid_tables_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">all_tables</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span> 
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">table_contains_keywords</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">table_html</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dfs</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_html</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nc">StringIO</span><span class="p">(</span><span class="n">table_html</span><span class="p">),</span> <span class="n">flavor</span><span class="o">=</span><span class="sh">"</span><span class="s">bs4</span><span class="sh">"</span><span class="p">)</span>
                <span class="c1"># print(dfs)
</span>            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="n">valid_dfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">dfs</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="sh">"</span><span class="s">columns</span><span class="sh">"</span><span class="p">).</span><span class="nf">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="sh">"</span><span class="s">rows</span><span class="sh">"</span><span class="p">).</span><span class="nf">fillna</span><span class="p">(</span><span class="sh">""</span><span class="p">)</span>
                <span class="n">valid_dfs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">valid_dfs</span><span class="p">:</span>
                <span class="n">valid_tables_data</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">valid_dfs</span><span class="p">)</span>
                <span class="n">context_list</span> <span class="o">=</span> <span class="nf">extract_table_context</span><span class="p">(</span><span class="n">html_string</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">context_rows</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">context_list</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_tables_context</span><span class="p">:</span>
                    <span class="n">valid_tables_context</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">context_list</span><span class="p">)</span>
                
    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">valid_tables_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># print("Warning: No valid tables found in the document. Using all tables")
</span>        <span class="n">valid_tables_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">all_tables</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span> 
            <span class="n">table_html</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dfs</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_html</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nc">StringIO</span><span class="p">(</span><span class="n">table_html</span><span class="p">),</span> <span class="n">flavor</span><span class="o">=</span><span class="sh">"</span><span class="s">bs4</span><span class="sh">"</span><span class="p">)</span>
                <span class="c1"># print(dfs)
</span>            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="n">valid_dfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">dfs</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="sh">"</span><span class="s">columns</span><span class="sh">"</span><span class="p">).</span><span class="nf">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="sh">"</span><span class="s">all</span><span class="sh">"</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="sh">"</span><span class="s">rows</span><span class="sh">"</span><span class="p">).</span><span class="nf">fillna</span><span class="p">(</span><span class="sh">""</span><span class="p">)</span>
                <span class="n">valid_dfs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">valid_dfs</span><span class="p">:</span>
                <span class="n">valid_tables_data</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">valid_dfs</span><span class="p">))</span>
                <span class="n">context_list</span> <span class="o">=</span> <span class="nf">extract_table_context</span><span class="p">(</span><span class="n">html_string</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">context_rows</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">context_list</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_tables_context</span><span class="p">:</span>
                    <span class="n">valid_tables_context</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">context_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">valid_tables_data</span><span class="p">,</span> <span class="n">valid_tables_context</span>    </code></pre></figure> <p> By explicitly extracting tables first, we preserve their row/column structure. Only once we have the valid tables do we hand them (plus context) to the LLM, rather than dumping raw HTML. </p> <hr> <h5>Issue 4: Adding a <code>peer_group</code> Column → Context from Table Headings</h5> <p> To know which “peer group” each multiple belongs to, we: </p> <ol> <li>Extract the table caption or the nearest heading text immediately preceding the table (e.g. “Selected Comparable Companies - Tech” or “Technology Peer Group”).</li> <li>Pass that heading into the LLM as part of <code>before_context</code>.</li> <li>In the prompt template, instruct the LLM to capture individual “peer_group” information for certain valuations based on that heading text.</li> </ol> In practice, this is handled by: <ul> <li> <code>extract_table_context</code> → returns <code>[context_before, context_after]</code> around each table as well as any table that is not a data table but has peer group information through certain keywords as captured in the KEYWORDS_CONTEXT list</li> <li>During prompt construction (<code>extractor</code>), we supply the LLM with both <code>table_data</code> and <code>before_context</code> so that “peer_group” can be parsed.</li> </ul> <figure class="highlight"><pre><code class="language-python" data-lang="python">  
<span class="n">KEYWORDS_CONTEXT</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">r</span><span class="sh">"</span><span class="s">selected.*compan(?:y|ies) (analysis|analyses)?</span><span class="sh">"</span><span class="p">,</span>
        <span class="sa">r</span><span class="sh">"</span><span class="s">selected.*public.*compan(?:y|ies)</span><span class="sh">"</span><span class="p">,</span>
        <span class="sa">r</span><span class="sh">"</span><span class="s">peer(?: group)?</span><span class="sh">"</span><span class="p">,</span>
        <span class="sa">r</span><span class="sh">"</span><span class="s">public(ly)? (traded )?compan(?:y|ies)</span><span class="sh">"</span><span class="p">,</span>
        <span class="sa">r</span><span class="sh">"</span><span class="s">comparable.public.*compan(?:y|ies).(analysis|analyses)</span><span class="sh">"</span><span class="p">,</span>
        <span class="sa">r</span><span class="sh">"</span><span class="s">implied multiples analysis</span><span class="sh">"</span><span class="p">,</span>
        <span class="sa">r</span><span class="sh">"</span><span class="s">price\s*(?:to|[\/:-])?\s*earnings</span><span class="sh">"</span>
        <span class="sa">r</span><span class="sh">"</span><span class="s">p\s*[./-]?\s*e(?:\s*ratio)?</span><span class="sh">"</span>
        <span class="sa">r</span><span class="sh">"</span><span class="s">price\s*(?:to|[\/:-])?\s*book</span><span class="sh">"</span>
        <span class="sa">r</span><span class="sh">"</span><span class="s">p\s*[./-]?\s*b(?:\s*ratio)?</span><span class="sh">"</span>
        <span class="sa">r</span><span class="sh">"</span><span class="s">ev\s*(?:to|[\/:-])?\s*ebitda</span><span class="sh">"</span>
        <span class="sa">r</span><span class="sh">"</span><span class="s">enterprise value\s*(?:to|[\/:-])?\s*ebitda</span><span class="sh">"</span>
        <span class="sa">r</span><span class="sh">"</span><span class="s">p\s*[./-]?\s*ebitda(?:\s*ratio)?</span><span class="sh">"</span>
        <span class="sh">'</span><span class="s">earnings per share</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">eps</span><span class="sh">'</span><span class="p">,</span>
        
<span class="p">]</span>

<span class="k">def</span> <span class="nf">extract_table_context</span><span class="p">(</span><span class="n">html_string</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">context_chars</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Locate the &lt;table&gt; text inside the normalized HTML. Then:
      - Grab `context_chars` characters immediately before the table (likely contains a heading/caption).
      - Grab `context_chars` characters immediately after the table.
      - Strip all HTML tags from both.
    
    Parameters:
      - html_string: The full HTML document as a string.
      - table: A BeautifulSoup table element.
      - context_chars: Number of characters to include before and after the table.
      - count: An identifier (e.g., table number) used in labeling the context.
      
    Returns:
      A string containing the cleaned context for the table.
    </span><span class="sh">"""</span>
    <span class="c1"># Convert the table element to string.
</span>    <span class="n">table_html</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
    
    <span class="c1"># Normalize both the full HTML and the table HTML to reduce formatting differences.
</span>    <span class="n">norm_html</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">'</span><span class="s">\s+</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">,</span> <span class="n">html_string</span><span class="p">).</span><span class="nf">strip</span><span class="p">()</span>
    <span class="n">norm_table_html</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">'</span><span class="s">\s+</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">,</span> <span class="n">table_html</span><span class="p">).</span><span class="nf">strip</span><span class="p">()</span>

    <span class="c1"># Find the table's start and end in the normalized HTML.
</span>    <span class="n">start_index</span> <span class="o">=</span> <span class="n">norm_html</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">norm_table_html</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">start_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="n">end_index</span> <span class="o">=</span> <span class="n">start_index</span> <span class="o">+</span> <span class="nf">len</span><span class="p">(</span><span class="n">norm_table_html</span><span class="p">)</span>
    <span class="c1"># Extend the context by context_chars before and after the table.
</span>    <span class="n">extended_start</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">start_index</span> <span class="o">-</span> <span class="n">context_chars</span><span class="p">)</span>
    <span class="n">extended_end</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">norm_html</span><span class="p">),</span> <span class="n">end_index</span> <span class="o">+</span> <span class="n">context_chars</span><span class="p">)</span>
    <span class="n">context_before</span> <span class="o">=</span> <span class="n">norm_html</span><span class="p">[</span><span class="n">extended_start</span><span class="p">:</span><span class="n">start_index</span><span class="p">]</span>
    <span class="n">context_after</span> <span class="o">=</span> <span class="n">norm_html</span><span class="p">[</span><span class="n">end_index</span><span class="p">:</span><span class="n">extended_end</span><span class="p">]</span>
    <span class="c1"># Remove HTML tags from the snippet using BeautifulSoup.
</span>    <span class="n">clean_context_before</span> <span class="o">=</span> <span class="nc">BeautifulSoup</span><span class="p">(</span><span class="n">context_before</span><span class="p">,</span> <span class="sh">"</span><span class="s">html.parser</span><span class="sh">"</span><span class="p">).</span><span class="nf">get_text</span><span class="p">(</span><span class="n">separator</span><span class="o">=</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">clean_context_after</span> <span class="o">=</span> <span class="nc">BeautifulSoup</span><span class="p">(</span><span class="n">context_after</span><span class="p">,</span> <span class="sh">"</span><span class="s">html.parser</span><span class="sh">"</span><span class="p">).</span><span class="nf">get_text</span><span class="p">(</span><span class="n">separator</span><span class="o">=</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">[</span><span class="n">clean_context_before</span><span class="p">,</span> <span class="n">clean_context_after</span><span class="p">]</span>


<span class="n">ddef</span> <span class="nf">extractor</span><span class="p">(</span><span class="n">input_table</span><span class="p">,</span> <span class="n">input_string</span><span class="p">,</span> <span class="n">batch</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Prompt</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Extracts relevant financial data from the input table and string using OpenAI</span><span class="sh">'</span><span class="s">s API.
    The function is designed to be called in batch mode or individually.
    
    Parameters:
        - input_table: The table data as a string.
        - input_string: The surrounding context as a string.
        - batch: Boolean indicating if the function is called in batch mode.
    </span><span class="sh">"""</span>

    
    <span class="c1">#   - `comparables_text`: A string containing all text parts related to a comparable company valuation analysis.
</span>    <span class="c1">#   In most cases, this will be a few paragraphs about the overall valuation technique with comparable companies. Do not include discounted cash flow analysis text.
</span>    <span class="c1">#    If applicable, include descriptions of the calculated multiples and comparable companies in addition to all the other info.
</span>    <span class="c1">#     'comparables_text': 'text', 
</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
    ### Task Instructions
    1. Read the tables that were preprocessed from an HTML file and the input string.
    2. Identify which table contains comparable company multiples and the peer group companies
    3. Extract and organize the following details into a structured dictionary. If you cannot find certain data, please leave the values empty and don</span><span class="sh">'</span><span class="s">t make data up:
    - `comparables_valuation` (list of structured dictionaries containing one key-value pair each)
            Each dictionary in the list must including:
        - **`advisor`**: The name of the financial advisor performing the analysis
        - **`date`** : The date of the multiple valuation (if present).
        - **`statistic`**: The statistic used on the reference ranges of the characteristics (e.g.,</span><span class="sh">'</span><span class="s">Min</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">Max</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">High</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">Low</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">Mean</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">Median</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">1st Quartile</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">3rd Quartile</span><span class="sh">'</span><span class="s">) - include al available.
        - **</span><span class="sh">'</span><span class="s">group</span><span class="sh">'</span><span class="s">**: Group/Name of the company that the multiple stems from. (e.g. </span><span class="sh">'</span><span class="s">peer group A</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">Semiconductor peer group</span><span class="sh">'</span><span class="s"> etc.). If the multiples    based on the company being assessed is present also include it with the company name as the value.
        - ** `numerator`** : The numerator of the valuation ratio (e.g., </span><span class="sh">'</span><span class="s">Share Price</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">Earnings of a specific year</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">EPS</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">Market Value</span><span class="sh">'</span><span class="s">).
        - ** `denominator`** : The denominator of the valuation ratio (e.g., </span><span class="sh">'</span><span class="s">Share Price</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">Earnings of a specific year</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">EPS</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">Market Value</span><span class="sh">'</span><span class="s">).
        - ** `multiple`** : The multiple used for the valuation (e.g., </span><span class="sh">'</span><span class="s">6.0</span><span class="sh">'</span><span class="s"> or some %%).
        - **`valuation`** : The resulting share price or value, if stated.
            The valuation value can be a range (e.g., </span><span class="sh">'</span><span class="s">between $10 and $20</span><span class="sh">'</span><span class="s">) or a single value (e.g., </span><span class="sh">'</span><span class="s">$15.00</span><span class="sh">'</span><span class="s">).
            If you can</span><span class="sh">'</span><span class="s">t find a valuation value or multiple, please write </span><span class="sh">"</span><span class="s">N/A</span><span class="sh">"</span><span class="s"> in the respective field but makre sure to use ALL the information from the tables and context.
            If you cannot find a value for an advisor or the date, go into the input string and find the closest date or advisor name through context or leave it empty if you still don</span><span class="sh">'</span><span class="s">t know.
            Often, multiple tables are used for different peer group. Its important to capture all peer groups because sometimes more than ONE advisor gives a comparable company analysis with different peer groups and different valuations
            Please make sure to account for that in the with the advisor column.  
            *DO NOT* include information from past transaction tables &amp; information, only comparable companies/public companies analysis - this is very important. Use context from the input string and or headings to get the right table.
            Make sure to include all multiples to other financial ratios that are given in the tables. Every row corresponds to a new multiple. If you cannot find a multiple, write </span><span class="sh">"</span><span class="s">N/A</span><span class="sh">"</span><span class="s"> in the respective field.
            Example output:
            data = [
            {</span><span class="sh">"</span><span class="s">advisor</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">Goldman Sachs</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">date</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">6/28/2007</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">statistic</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">median</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">group</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">semiconductor peer group</span><span class="sh">"</span><span class="s">, numerator</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">share price</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">denominator</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">2007E Earnings GAAP</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">multiple</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">14.8</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">valuation</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">$60.00</span><span class="sh">"</span><span class="s">},
            {</span><span class="sh">"</span><span class="s">advisor</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">Goldman Sachs</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">date</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">6/28/2007</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">statistic</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">mean</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">group</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">peer group</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">numerator</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">share price</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">denominator</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">2007E Earnings GAAP</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">multiple</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">13</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">valuation</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">$60.00</span><span class="sh">"</span><span class="s">},
            {</span><span class="sh">"</span><span class="s">advisor</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">Goldman Sachs</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">date</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">6/28/2007</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">statistic</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">mean</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">group</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">peer group</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">numerator</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">share price</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">denominator</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">Book Value</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">multiple</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">7.0</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">valuation</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">$70.00</span><span class="sh">"</span><span class="s">},
            {</span><span class="sh">"</span><span class="s">advisor</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">Morgan Stanley</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">date</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">6/28/2007</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">statistic</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">median</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">group</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">peer group</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">numerator</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">2008E EPS</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">denominator</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">2007E EPS</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">multiple</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">9%%</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">valuation</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">$65.00</span><span class="sh">"</span><span class="s">},
            {</span><span class="sh">"</span><span class="s">advisor</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">Barkleys</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">date</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">6/28/2007</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">statistic</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">median</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">group</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">SELF</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">numerator</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">Enterprise value</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">denominator</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s"> 2009E Distributable Cash Flow</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">multiple</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">38</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">valuation</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">NA</span><span class="sh">"</span><span class="s">}
            ]
            Sort the dictionaries in the list by item and by date.

    - `comparables_peers` (list of dictionaries):
            Each dictionary in the list must include:
            - **` `advisor`**`: The name of the financial advisor performing the analysis
            - **` `peer`**`: The name of each comparable company used in the analysis.
            - **` `peer_group`**`: Which peer group the company belongs to (if stated).
            This data will often be shown as </span><span class="sh">'</span><span class="s">Selected Comparable Companies</span><span class="sh">'</span><span class="s"> or something similar. 
            Sometimes more than ONE advisor gives a comparable company analysis. Use the Input HTML as context to find out which advisor creates which peer group (somtimes this info is ONLY in the input string so be careful).
    4. Ensure the output dictionary is complete, consistent, and well-structured. Please add nothing else but give just the dictionary.
    5. Provide the output as a valid Python dictionary with the keys 
        - </span><span class="sh">'</span><span class="s">comparables_valuation</span><span class="sh">'</span><span class="s">
        - </span><span class="sh">'</span><span class="s">comparables_peers</span><span class="sh">'</span><span class="s">
       - Do not add any extra text or summary.

    Example output:
    ```python
{
  </span><span class="sh">"</span><span class="s">comparables_valuation</span><span class="sh">"</span><span class="s">: [
    {</span><span class="sh">"</span><span class="s">advisor</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">Goldman Sachs</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">date</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">6/28/2007</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">statistic</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">median</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">group</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">semiconductor peer group</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">numerator</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">share price</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">denominator</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">2007E Earnings GAAP</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">multiple</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">14.8</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">valuation</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">$60.00</span><span class="sh">"</span><span class="s">},
    {</span><span class="sh">"</span><span class="s">advisor</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">Goldman Sachs</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">date</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">6/28/2007</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">statistic</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">mean</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">group</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">peer group</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">numerator</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">share price</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">denominator</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">2007E Earnings GAAP</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">multiple</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">13</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">valuation</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">$60.00</span><span class="sh">"</span><span class="s">}
    // ... additional entries ...
  ],
  </span><span class="sh">"</span><span class="s">comparables_peers</span><span class="sh">"</span><span class="s">: [
    {</span><span class="sh">"</span><span class="s">advisor</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">Goldman Sachs</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">peer</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">Apple</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">peer_group</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">semiconductor</span><span class="sh">"</span><span class="s">}
    // ... additional entries ...
  ]
}
  </span><span class="sh">"""</span>  <span class="o">+</span>  <span class="sa">f</span><span class="sh">"""</span><span class="s">
        Here are the tables, but only take data from comparable company tables and not past transaction tables (will be in the headers of the table normallly)
        </span><span class="sh">'''</span><span class="s">
        </span><span class="si">{</span><span class="n">input_table</span><span class="si">}</span><span class="s">
        </span><span class="sh">'''</span><span class="s">
        </span><span class="sh">"""</span>  <span class="o">+</span> <span class="sa">f</span><span class="sh">"""</span><span class="s"> 
        </span><span class="se">\n</span><span class="s"> 
        Here is the input string that was extracted from the HTML file:
        </span><span class="se">\n</span><span class="s">
        </span><span class="sh">'''</span><span class="s">
        </span><span class="si">{</span><span class="n">input_string</span><span class="si">}</span><span class="s">
        </span><span class="sh">'''</span><span class="s">
        </span><span class="sh">"""</span>
    <span class="n">system</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
    You</span><span class="sh">'</span><span class="s">re an excellent information extractor from tables and SEC filings .
    
    You</span><span class="sh">'</span><span class="s">re gathering financial projections and therefore extract information from markdown tables.
    These tables contain financial multiple analysis.
    Your role is to process these projections and store the data in a dictionary with a certain structure.
    
    Your goal is to create it a dictionary that contains the relevant projections. Please only output the dictionary and no extra text.</span><span class="sh">'</span><span class="s">
    </span><span class="sh">"""</span>
    <span class="c1">#print(prompt)
</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">batch</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">call_gpt_api</span><span class="p">(</span><span class="n">system_message</span> <span class="o">=</span> <span class="n">system</span><span class="p">,</span> <span class="n">user_message</span> <span class="o">=</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">param_model</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">param_temperature</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">system</span></code></pre></figure> <hr> <h4>Summary of the New Pipeline Flow</h4> <ol> <li> <strong>Read HTML file</strong> → <code>html_string = open(...).read()</code> </li> <li> <strong>Extract all valid tables first</strong> with <code>get_valid_tables_with_context(html_string)</code>. This returns: <ul> <li> <code>valid_tables_data</code> (list of DataFrame text)</li> <li> <code>valid_tables_context</code> (list of [before, after] context strings)</li> </ul> </li> <li> <strong>Concatenate tables + context</strong> into <code>table_input</code> (join each “before + table_data + after”). </li> <li> <strong>Token check:</strong> <code>token_length = num_tokens(table_input)</code> &amp; <code>html_string_length = num_tokens(html_string)</code>. If <code>token_length + html_string_length ≤ MAX_TOKEN</code>, call LLM with both; else call with only <code>table_input + keyword_context</code>. </li> <li> <strong>LLM prompt</strong> uses both: <ul> <li> <code>input_table</code> (all valid tables as plaintext)</li> <li> <code>input_string</code> (merged contexts, which contain “peer_group” headings)</li> </ul> In the system prompt, instruct the model to extract “peer_group,” “advisor,” “date,” etc. </li> <li> <strong>Collect LLM output</strong> (JSON dictionaries). Write them to <code>batch_file</code> as JSONL for offline parsing. </li> </ol> <p> With these changes, we: </p> <ul> <li> <strong>Eliminated redundant expansions</strong> (Issue 2) by merging intervals in <code>extract_passages</code>. </li> <li> <strong>Distinguished tables vs. raw text</strong> (Issue 3) by filtering via <code>is_data_table</code>. </li> <li> <strong>Captured “peer_group”</strong> (Issue 4) by pulling the heading into <code>context_string</code> and prompting the LLM. </li> <li> <strong>Reduced costs</strong> (Issue 1) by skipping the full‐document approach when token limits would be exceeded. </li> </ul> The result is a far more accurate, lower‐cost pipeline that reliably extracts peer‐group multiples from diverse SEC filings. The full code for calling these functions would then look like this: <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Open the output JSONL batch file for writing
</span><span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">batch_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_out</span><span class="p">:</span>
    <span class="c1"># Compute half the length of preprocessed files (for potential sub‐sampling)
</span>    <span class="n">length_halved</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">preprocessed_files_data</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Instead of iterating over all preprocessed files, here we use a single test file for demonstration
</span>    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># Override f with the test file path
</span>        <span class="n">f</span> <span class="o">=</span> <span class="n">test</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Extract the document name (filename without extension)
</span>            <span class="n">document_name</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">/</span><span class="sh">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">.</span><span class="sh">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Derive document_type and year from the parent directory name (e.g., "DEFM14A_2021")
</span>            <span class="n">document_type</span><span class="p">,</span> <span class="n">year</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">/</span><span class="sh">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">_</span><span class="sh">'</span><span class="p">)</span>

            <span class="c1"># Determine the file extension (e.g., "html", "txt", or "htm")
</span>            <span class="n">file_type</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">.</span><span class="sh">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Construct the path to the preprocessed version by replacing folder and extension
</span>            <span class="n">g</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">f</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">'</span><span class="s">0-raw-data/DEFM14A</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">1-relevant-data/valuations</span><span class="sh">'</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">'</span><span class="s">.htm</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">.html</span><span class="sh">'</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">'</span><span class="s">.txt</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">.html</span><span class="sh">'</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

            <span class="c1"># Check if the preprocessed file exists
</span>            <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">g</span><span class="p">):</span>
                <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Preprocessed Available</span><span class="sh">'</span><span class="p">)</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">g</span>  <span class="c1"># Use the preprocessed version from this point
</span>                <span class="n">preprocessed_version</span> <span class="o">=</span> <span class="sh">'</span><span class="s">Available</span><span class="sh">'</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Preprocessed Not Available</span><span class="sh">'</span><span class="p">)</span>
                <span class="c1"># Skip this file if we cannot find a preprocessed version
</span>                <span class="k">continue</span>

            <span class="c1"># Read the entire HTML content of the preprocessed file
</span>            <span class="n">html_string</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="sh">'</span><span class="s">r</span><span class="sh">'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">).</span><span class="nf">read</span><span class="p">()</span>

            <span class="c1"># Define keywords for extracting “keyword context” (adding the year as well)
</span>            <span class="n">relative_keywords</span> <span class="o">=</span> <span class="n">KEYWORDS_CONTEXT</span> <span class="o">+</span> <span class="p">[</span><span class="n">year</span><span class="p">]</span>

            <span class="c1"># 1.) Extract keyword context from non‐table portions of the HTML
</span>            <span class="n">keyword_context</span> <span class="o">=</span> <span class="nf">extract_keyword_context</span><span class="p">(</span>
                <span class="n">html_string</span><span class="p">,</span> <span class="n">KEYWORDS_CONTEXT</span><span class="p">,</span> <span class="n">KEYWORD_CONTEXT_ROWS</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">keyword_context</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nf">print</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">keyword_context</span><span class="p">))</span>

            <span class="c1"># 2.) Parse all valid tables and their surrounding context from the HTML
</span>            <span class="n">valid_tables_data</span><span class="p">,</span> <span class="n">valid_tables_context</span> <span class="o">=</span> <span class="nf">get_valid_tables_with_context</span><span class="p">(</span>
                <span class="n">html_string</span><span class="p">,</span>
                <span class="n">numeric_threshold</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                <span class="n">context_rows</span><span class="o">=</span><span class="n">TABLE_CONTEXT_CHARS</span>
            <span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Valid Tables:</span><span class="sh">'</span><span class="p">,</span> <span class="n">valid_tables_data</span><span class="p">)</span>

            <span class="c1"># 3.) Build `table_input` by concatenating each table’s text + its before/after context
</span>            <span class="n">table_input_parts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">table_data</span><span class="p">,</span> <span class="n">table_context</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">valid_tables_data</span><span class="p">,</span> <span class="n">valid_tables_context</span><span class="p">):</span>
                <span class="c1"># If context exists, pull out “before” and “after” snippets; otherwise, empty string
</span>                <span class="n">before_context</span> <span class="o">=</span> <span class="n">table_context</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">table_context</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">table_context</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="sh">""</span>
                <span class="n">after_context</span> <span class="o">=</span> <span class="n">table_context</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">table_context</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">table_context</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="sh">""</span>
                <span class="c1"># Combine them with newlines to form one chunk per table
</span>                <span class="n">table_input_parts</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">before_context</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span> <span class="o">+</span> <span class="n">table_data</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span> <span class="o">+</span> <span class="n">after_context</span><span class="p">)</span>

            <span class="c1"># Join all table chunks into a single string
</span>            <span class="n">table_input</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">table_input_parts</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">table_input</span><span class="p">)</span>

            <span class="c1"># Preprocess the HTML to plain text (strip tags, reduce whitespace)
</span>            <span class="n">html_string</span> <span class="o">=</span> <span class="nf">preprocess_html</span><span class="p">(</span><span class="n">html_string</span><span class="p">)</span>

            <span class="c1"># Compute token counts for each component
</span>            <span class="n">token_length</span> <span class="o">=</span> <span class="nf">num_tokens_from_string</span><span class="p">(</span><span class="n">table_input</span><span class="p">,</span> <span class="n">encoding</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">context_length</span> <span class="o">=</span> <span class="nf">num_tokens_from_string</span><span class="p">(</span><span class="n">keyword_context</span><span class="p">,</span> <span class="n">encoding</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">html_string_length</span> <span class="o">=</span> <span class="nf">num_tokens_from_string</span><span class="p">(</span><span class="n">html_string</span><span class="p">,</span> <span class="n">encoding</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
            <span class="c1"># (Debug prints removed; rely on calculated values below)
</span>
            <span class="c1"># 4.) Decide which context to send to the LLM based on token budget
</span>            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">table_input</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tables_found</span> <span class="o">=</span> <span class="sh">'</span><span class="s">tables_found</span><span class="sh">'</span>
                <span class="c1"># If total tokens (tables + full HTML) fits under MAX_TOKEN, send full context
</span>                <span class="nf">if </span><span class="p">(</span><span class="n">token_length</span> <span class="o">+</span> <span class="n">html_string_length</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">MAX_TOKEN</span><span class="p">:</span>
                    <span class="n">context</span> <span class="o">=</span> <span class="sh">'</span><span class="s">full_doc</span><span class="sh">'</span>
                    <span class="n">prompt</span><span class="p">,</span> <span class="n">system</span> <span class="o">=</span> <span class="nf">extractor</span><span class="p">(</span><span class="n">table_input</span><span class="p">,</span> <span class="n">html_string</span><span class="p">,</span> <span class="n">batch</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

                    <span class="c1"># Construct a JSONL request for the LLM
</span>                    <span class="n">json_obj</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">custom_id</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">document_name</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">document_type</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">context</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">file_type</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">tables_found</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">method</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">/v1/chat/completions</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                            <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">param_model</span><span class="p">,</span>
                            <span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">:</span> <span class="n">param_temperature</span><span class="p">,</span>
                            <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span>
                                <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">system</span><span class="p">},</span>
                                <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span>   <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}</span>
                            <span class="p">]</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="c1"># Write the JSON object as one line in the output file
</span>                    <span class="n">f_out</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">json_obj</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Token budget exceeded: fall back to “table + keyword context” only
</span>                    <span class="n">context</span> <span class="o">=</span> <span class="sh">'</span><span class="s">keyword_context</span><span class="sh">'</span>
                    <span class="n">prompt</span><span class="p">,</span> <span class="n">system</span> <span class="o">=</span> <span class="nf">extractor</span><span class="p">(</span><span class="n">table_input</span><span class="p">,</span> <span class="n">keyword_context</span><span class="p">,</span> <span class="n">batch</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

                    <span class="n">json_obj</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">custom_id</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">document_name</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">document_type</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">context</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">file_type</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">tables_found</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">method</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">/v1/chat/completions</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                            <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">param_model</span><span class="p">,</span>
                            <span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">:</span> <span class="n">param_temperature</span><span class="p">,</span>
                            <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span>
                                <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">system</span><span class="p">},</span>
                                <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span>   <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}</span>
                            <span class="p">]</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="n">f_out</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">json_obj</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># No valid tables found: handle “no_tables_found” case
</span>                <span class="n">tables_found</span> <span class="o">=</span> <span class="sh">'</span><span class="s">no_tables_found</span><span class="sh">'</span>
                <span class="c1"># If full HTML fits under MAX_TOKEN, use full_doc
</span>                <span class="k">if</span> <span class="n">html_string_length</span> <span class="o">&lt;=</span> <span class="n">MAX_TOKEN</span><span class="p">:</span>
                    <span class="n">context</span> <span class="o">=</span> <span class="sh">'</span><span class="s">full_doc</span><span class="sh">'</span>
                    <span class="n">prompt</span><span class="p">,</span> <span class="n">system</span> <span class="o">=</span> <span class="nf">extractor</span><span class="p">(</span><span class="sh">''</span><span class="p">,</span> <span class="n">html_string</span><span class="p">,</span> <span class="n">batch</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

                    <span class="n">json_obj</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">custom_id</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">document_name</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">document_type</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">context</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">file_type</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">tables_found</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">method</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">/v1/chat/completions</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                            <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">param_model</span><span class="p">,</span>
                            <span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">:</span> <span class="n">param_temperature</span><span class="p">,</span>
                            <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span>
                                <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">system</span><span class="p">},</span>
                                <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span>   <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}</span>
                            <span class="p">]</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="n">f_out</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">json_obj</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Too large: use only keyword context
</span>                    <span class="n">context</span> <span class="o">=</span> <span class="sh">'</span><span class="s">keyword_context</span><span class="sh">'</span>
                    <span class="n">prompt</span><span class="p">,</span> <span class="n">system</span> <span class="o">=</span> <span class="nf">extractor</span><span class="p">(</span><span class="sh">''</span><span class="p">,</span> <span class="n">keyword_context</span><span class="p">,</span> <span class="n">batch</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

                    <span class="n">json_obj</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">custom_id</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">document_name</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">document_type</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">context</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">file_type</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">tables_found</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">method</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">/v1/chat/completions</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                            <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span> <span class="n">param_model</span><span class="p">,</span>
                            <span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">:</span> <span class="n">param_temperature</span><span class="p">,</span>
                            <span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span>
                                <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">system</span><span class="p">},</span>
                                <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span>   <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}</span>
                            <span class="p">]</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="n">f_out</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">json_obj</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># If any error occurs during processing, print the filename &amp; error message
</span>            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Error processing file </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div> <h3>Results: Ordered Excel/JSON files for all</h3> <p>The final results looks something like this for every company by transforming the json file from the batch request into individual excel files which are then sample checked for accuracy.</p> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/theis_research/example_val-480.webp 480w,/assets/img/theis_research/example_val-800.webp 800w,/assets/img/theis_research/example_val-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/theis_research/example_val.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Comparable Valuation result example statement" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> This figure illustrates an example of the output from the comparable valuation analysis, showcasing the valuation multiples derived from peer group comparisons. </div> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/theis_research/example_peers-480.webp 480w,/assets/img/theis_research/example_peers-800.webp 800w,/assets/img/theis_research/example_peers-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/theis_research/example_peers.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Comparable Peers result example statement" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> This figure highlights an example of the peer group analysis, detailing the selected comparable companies used in the valuation process. </div> <p>We then merge these results based on the file name present in each excel/json file to a meta-data dataset that has the company being evaluated and the discounted cash flow (DCF) information one of my colleques extracted.</p> <h3>Conclusion and Relfection: From Business Major to Research-Driven Quant</h3> <p> This experience wasn’t just technical-it was transformative. I’ve learned how ideas turn into publishable research, how collaboration drives innovation, and how intellectual generosity (thanks to Prof. Jensen and my incredible teammates) creates an environment where you genuinely want to do your best work. </p> <p> I’ve sharpened my Python and data engineering skills, learned to work with messy real-world data, use LLMs to work with such data, and gained an intuitive grasp of valuation logic that no textbook could offer. Most importantly, I’ve become certain of one thing: <strong>I want to keep doing this.</strong> I want to continue similar ideas as side-projects </p> <hr> <p> If you're curious about the technical side of the project, or if you want to collaborate on related research, feel free to reach out. I'm always happy to talk data, finance, and ideas. </p> </article> <h2>References</h2> <div class="publications"> </div> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Frederik K. Ciupek. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>